@model IEnumerable<DepartmentViewModel>

@{
    ViewData["Title"] = "Departments";
}

<h1>Departments</h1>

@if (User.IsInRole("Admin"))
{
    <a asp-action="Create" class="btn btn-success mb-3">➕ Add New Department</a>
    <div class="row mb-3">
        <div class="col-md-6">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by department name...">
        </div>
    </div>
}


<table class="table table-striped table-bordered shadow" id="departmentTable">
    <thead class="table-dark text-center">
        <tr>
            <th>NO</th>
            <th>Name</th>
            <th>Teachers</th>
            <th>Courses</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="tableBody">
        @if (Model != null && Model.Any())
        {
            int i = 1;
            @foreach (var item in Model)
            {
                <tr class="department-row" data-name="@item.Name.ToLower()">
                    <td class="text-center">@i++</td>
                    <td>@Html.DisplayFor(modelItem => item.Name)</td>
                    <td>@Html.DisplayFor(modelItem => item.TeacherCount)</td>
                    <td>@Html.DisplayFor(modelItem => item.CourseCount)</td>
                    <td>
                        @if (User.IsInRole("Admin"))
                        {
                            <a asp-action="Edit" asp-route-id="@item.DepartmentID" class="btn btn-warning btn-sm mx-1">
                                <i class="bi bi-pencil-square"></i> Edit
                            </a>
                            <a asp-action="Delete" asp-route-id="@item.DepartmentID" class="btn btn-danger btn-sm mx-1">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        }
                        <a asp-action="Details" asp-route-id="@item.DepartmentID" class="btn btn-info btn-sm mx-1">
                            <i class="bi bi-eye"></i> View
                        </a>

                    </td>
                </tr>
            }
           
        }
    </tbody>
</table>

@section Scripts {
    <script>
        $(document).ready(function() {
            let currentPage = 1;
            const allRows = $('.department-row');
            let visibleRows = allRows;
            const rowsPerPage = 5;

            function showPage(page) {
                const totalPages = Math.ceil(visibleRows.length / rowsPerPage);
                if (page < 1) page = 1;
                if (page > totalPages) page = totalPages;
                currentPage = page;

                const startIndex = (page - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;

                allRows.hide();
                visibleRows.slice(startIndex, endIndex).show();
                updatePagination();
            }

            function updatePagination() {
                const totalPages = Math.ceil(visibleRows.length / rowsPerPage);
                const pagination = $('#pagination');
                pagination.empty();

                if (totalPages <= 1) {
                    pagination.hide();
                    return;
                }
                pagination.show();

                pagination.append(`
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" aria-label="Previous" data-page="${currentPage - 1}">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                `);

                for (let i = 1; i <= totalPages; i++) {
                    pagination.append(`
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${i}">${i}</a>
                        </li>
                    `);
                }

                pagination.append(`
                    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" aria-label="Next" data-page="${currentPage + 1}">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                `);
            }

            $('#searchInput').on('keyup', function() {
                const searchText = $(this).val().toLowerCase();

                if (searchText === '') {
                    visibleRows = allRows;
                } else {
                    visibleRows = allRows.filter(function() {
                        return $(this).data('name').includes(searchText);
                    });
                }

                currentPage = 1;
                showPage(currentPage);
            });

            $(document).on('click', '.page-link', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (!isNaN(page)) {
                    showPage(parseInt(page));
                }
            });

            showPage(currentPage);
        });
    </script>
}